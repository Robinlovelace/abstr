---
title: "Using PCT with abstr"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Using PCT to create local authority active travel imaganaries}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
author: 
- "Nathanael Sheehan and Robin"
---
```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Introduction 
The `abstr` package was originally developed as part of the Active Travel Orientated Development paper by Talbolt et al. (2021): this study assessed the active travel prevision of new and proposed housing development sites in England and Wales. The [ActDev]() website, which visualizes all 38 sites used in the study, is fueled by a reproducible R (project)[https://github.com/cyipt/actdev/tree/main/code] which was the basis for creation of `abstr`. To understand the methods and motivations behind `abstr`, one must become familiar with the history and ecosystem of open access transport models built in R. The history begins in 2017 with The Propensity to Cycle Tool (PCT), an open source transport planning system for England and Wales. The PCT (package)[https://github.com/ITSLeeds/pct] features an open approach to data access, route calculation and scenario of change modeling (not forecasting) at the regional, MSOA and LSOA geographical scales. Moreover, PCT provides a range of deterministic scenarios of change, such as `go_dutch` (where cycling levels matches that of the Netherlands), `gender_eq` (where there is equal levels of cycling among Female and Males) and `gov_target` (where cycling levels reflect that of UK government current targets). An academic (paper)[https://www.jtlu.org/index.php/jtlu/article/view/862] on the PCT provides further detail on the motivations for and methods underlying the project. In 2018 the beasty `stplanr` (sustainable transport planning) package and R journal (article)[https://journal.r-project.org/archive/2018/RJ-2018-053/RJ-2018-053.pdf] came on the scene, and further provided functions for solving common problems in transport planning and modeling, as well as advocating a transparency in tool usage within the transport planning paradigm. Finally, in 2021 the `od` package was released which provided functions for working with origin-destination data. A central focus in all of the packages and papers mentioned above is to provide open access transport tools which support transparent transport policies. While these packages finish our open access transport model history, several other open access R packages enabled the creation of `abstr`. 

These include:

*    jsonlite for awesome JSON parsing and generation [https://cran.r-project.org/web/packages/jsonlite/index.html]
*    magrittr for magic `%>%` pipe-command chaining [https://cran.r-project.org/web/packages/magrittr/index.html],
*    sf  for simple feature support (https://cran.r-project.org/web/packages/sf/index.html)
*    tibble for strict data-frame declaration (https://cran.r-project.org/web/packages/tibble/index.html)
*    tidyr for all things data cleaning (https://cran.r-project.org/web/packages/tidyr/index.html)


## Getting started
In order to import scenario files into A/B Street, you will need to:

* Install a stable version of [Rstudio and R](https://www.rstudio.com/products/rstudio/)
* Install a stable version of [Rust](https://www.rust-lang.org/tools/install)
  + On Windows, you will also need [Visual Code Studio](https://code.visualstudio.com/) and [Visual Studio c++ build tools](https://visualstudio.microsoft.com/downloads/) prior to installing Rust.
* On Linux, run `sudo apt-get install libasound2-dev libxcb-shape0-dev libxcb-xfixes0-dev libpango1.0-dev libgtk-3-dev` or the equivalent for your distribution.
* Download the A/B Street repo `git clone https://github.com/a-b-street/abstreet.git`
* Fetch the minimal amount of data needed to get started `cargo run --bin updater -- --minimal`


Given you have all of the above, you are ready to start transforming data-frames into simulations! So lets set an aim for the vignette

```{r eval=FALSE}
####
####
#### AIM: Use PCT data to create scenario of change where commuting cycling levels increase and car journeys decrease which can be imported
####      into A/B Street city simulation software. This method should be fully reproducible for all other pct_regions.
####
####
```

### Installing and Loading Packages 

To begin with, you need to install and load the nesseccary packages for this vignette.

```{r eval=FALSE}
#### INSTALL PACKAGES ####
cran_pkgs = c("abstr","pct","osmextract","sf","tidyverse")
devtools::install_cran(cran_pkgs)
#### LOAD PACKAGES ####
library(abstr)
library(pct)
library(osmextract)
library(sf)
library(tidyverse)
```


### Fetching PCT Data

Next you want to fetch two types of PCT data. Firstly, zone data, which is gathered using the `get_pct_zones()` function and is filtered to only include a local authority of choice, in this example we use Exeter. Secondly, commute data, which is gathered using the `get_pct_lines()` function and is also filtered to only include trips within the local authority. 

```{r eval=FALSE}
####    READ DATA ####
devon_zones = pct::get_pct_zones(region = "devon", geography = "msoa") # get zone data
exeter_zones = devon_zones %>% filter(lad_name == "Exeter") %>% select(geo_code) # filter for exeter

exeter_commute_od = pct::get_pct_lines(region = "devon", geography = "msoa") %>% # get commute od data
  filter(lad_name1 == "Exeter" &
           lad_name2 == "Exeter") # filter for exeter
```


### Data Cleaning and Transformation

Now you have your data, its time to clean and transform it. In fact, you only need to transform the `exeter_commute_od` dataframe as the `exeter_zones` is already in `abstr` format. The first step in cleaning the data requires renaming variables so that we can clearly see the difference between the base scenario and the scenario of change. Next, you calculate the scenario of change, in this example we use the `uptake_pct_godutch_2020()` function which takes two arguments of `distance` and `gradient` in its model calculation. The results from this PCT function allow you to calculate the mode shift from driving to cycling. Finally, we subset the data to only include the columns which are needed to progress.

```{r eval=FALSE}
exeter_commute_od = exeter_commute_od %>%
  mutate(cycle_base = bicycle) %>%
  mutate(walk_base = foot) %>%
  mutate(transit_base = bus + train_tube) %>% # bunch of renaming -_-
  mutate(drive_base = car_driver + car_passenger + motorbike + taxi_other) %>%
  mutate(all_base = all) %>%
  mutate(
    # create new columns
    pcycle_godutch_uptake = pct::uptake_pct_godutch_2020(distance = rf_dist_km, gradient = rf_avslope_perc),
    cycle_godutch_additional = pcycle_godutch_uptake * drive_base,
    cycle_godutch = cycle_base + cycle_godutch_additional,
    pcycle_godutch = cycle_godutch / all_base,
    drive__godutch = drive_base - cycle_godutch_additional,
    across(c(drive__godutch, cycle_godutch), round, 0),
    all_go_dutch = drive__godutch + cycle_godutch + transit_base + walk_base
  ) %>%
  select(
    # select variables for new df
    geo_code1,
    geo_code2,
    cycle_base,
    drive_base,
    walk_base,
    transit_base,
    all_base,
    all_go_dutch,
    drive__godutch,
    cycle_godutch,
    cycle_godutch_additional,
    pcycle_godutch
  )
```

As a quick sanity check we can make sure our model has not generated any new commutes and we still have the same base number of commuters as before. 

```{r eval=FALSE}
identical(exeter_commute_od$all_base, exeter_commute_od$all_go_dutch) # sanity check: make sure total remains the same (this is not a dynamic model where population change is factored in)
```

### Download OSM building data

Now, you need to download OSM building data to populate the AB Street simulation map. In this example we use the `osmextract` package to fetch a PBF (protocolbuffer binary format) file hosted on GeoFabrik. You then need to filter the contents of the PBF file to only include the defined building types and subset the data to only include `osm_way_id, name, building` columsn. 

```{r eval=FALSE}
####    DOWNLOAD OSM BUILDING DATA ####
osm_polygons = osmextract::oe_read(
  "https://download.geofabrik.de/europe/great-britain/england/devon-latest.osm.pbf",
  # download osm buildings for region using geofabrik
  layer = "multipolygons"
)

building_types = c(
  "yes",
  "house",
  "detached",
  "residential",
  "apartments",
  "commercial",
  "retail",
  "school",
  "industrial",
  "semidetached_house",
  "church",
  "hangar",
  "mobile_home",
  "warehouse",
  "office",
  "college",
  "university",
  "public",
  "garages",
  "cabin",
  "hospital",
  "dormitory",
  "hotel",
  "service",
  "parking",
  "manufactured",
  "civic",
  "farm",
  "manufacturing",
  "floating_home",
  "government",
  "bungalow",
  "transportation",
  "motel",
  "manufacture",
  "kindergarten",
  "house_boat",
  "sports_centre"
)
osm_buildings  = osm_polygons %>%
  dplyr::filter(building %in% building_types) %>%
  dplyr::select(osm_way_id, name, building)

osm_buildings_valid = osm_buildings[sf::st_is_valid(osm_buildings), ]

exeter_osm_buildings_all = osm_buildings_valid[exeter_zones, ]
```


### Importing scenario files into A/B Street

Once you have all of this up and running, you will be able to run the scenario import. To start, open up a terminal in Visual Studio or your chosen IDE. Next edit the following command to include the local path of your scenario.json file.
```
cargo run --bin import_traffic -- --map=data/system/us/seattle/maps/montlake.bin --input=/path/to/input.json
```

Given you have correctly set the file path, the scenario should now be imported into your local version of the Montlake map. Next you can run the following command to start the A/B Street simulation in Montlake.

```
cargo run --bin game -- --dev data/system/us/seattle/maps/montlake.bin
```  

Once the game has booted up click on the `scenarios` tab in the top right, it will currently be set as "none". Change this to the first option "Montlake Example" which will be the scenario we have just uploaded. Alternatively, you can skip the first import command and use the GUI to select a scenario file to import.
