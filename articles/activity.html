<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Multi-trip activity models • abstr</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Multi-trip activity models">
<meta property="og:description" content="abstr">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">abstr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.3.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/abstr.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/activity.html">Multi-trip activity models</a>
    </li>
    <li>
      <a href="../articles/montlake.html">Reproducing Montlake Eastside Seattle, US</a>
    </li>
    <li>
      <a href="../articles/pct_to_abstr.html">Visualising cycling potential with A/B Street</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/a-b-street/abstr/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="activity_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Multi-trip activity models</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/a-b-street/abstr/blob/master/vignettes/activity.Rmd"><code>vignettes/activity.Rmd</code></a></small>
      <div class="hidden name"><code>activity.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p>Simple representations of transport systems based on origin-destination data often represent daily travel patterns as a single main trip per day, without distinguishing between multiple stages in a multi-stage trip (walk -&gt; bus -&gt; walk -&gt; destination trips are simply represented as bus -&gt; destination) or even multiple trips during the course of the day (omitting the fact that many people take a lunchtime trip to get lunch or simply to stretch their legs each day).</p>
<p>The concept of an ‘activity model’ aims to address these limitations by representing the complete list of activities undertaken by people throughout the day in the activity model. In this sense A/B Street can be seen as an activity model.</p>
<p>To show how A/B Street represents activity model data, we will take a hypothetical example, a trip from home to work and then to the park, to lunch and then to work before returning home after work. This 5 trip activity is more realistic that simple OD based models that just represents people travelling from home to work (and not back again in many cases), and is illustrated in the figure below.</p>
<p><img src="od-sketch.png"></p>
<p>How to get this information into a format for modelling? This article demonstrates how the data can be represented in R with the <code>abstr</code> package, and then converted into a format that can be imported by A/B Street.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/a-b-street/abstr">abstr</a></span><span class="op">)</span></code></pre></div>
</div>
<div id="minimal-example" class="section level1">
<h1 class="hasAnchor">
<a href="#minimal-example" class="anchor"></a>Minimal example</h1>
<p>In R code, the minimal example shown above can be represented as two data frames (tabular datasets), one representing trip origins and destinations and the other representing movement between them, as follows:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">places</span> <span class="op">=</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html">tribble</a></span><span class="op">(</span>
  <span class="op">~</span><span class="va">name</span>, <span class="op">~</span><span class="va">x</span>, <span class="op">~</span><span class="va">y</span>,
  <span class="st">"Home"</span>, <span class="op">-</span><span class="fl">1.524</span>, <span class="fl">53.819</span>,
  <span class="st">"Work"</span>, <span class="op">-</span><span class="fl">1.552</span>, <span class="fl">53.807</span>,
  <span class="st">"Park"</span>, <span class="op">-</span><span class="fl">1.560</span>, <span class="fl">53.812</span>,
  <span class="st">"Cafe"</span>, <span class="op">-</span><span class="fl">1.556</span>, <span class="fl">53.802</span>
<span class="op">)</span>
<span class="va">places_sf</span> <span class="op">=</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="va">places</span>, coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span>, crs <span class="op">=</span> <span class="fl">4326</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">places_sf</span>, pch <span class="op">=</span> <span class="va">places</span><span class="op">$</span><span class="va">name</span><span class="op">)</span></code></pre></div>
<p><img src="activity_files/figure-html/places-1.png" width="700"></p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># mapview::mapview(places_sf, pch = places$name)</span></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">od</span> <span class="op">=</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html">tribble</a></span><span class="op">(</span>
  <span class="op">~</span><span class="va">o</span>, <span class="op">~</span><span class="va">d</span>, <span class="op">~</span><span class="va">mode</span>, <span class="op">~</span><span class="va">departure</span>, <span class="op">~</span><span class="va">person</span>,
  <span class="st">"Home"</span>, <span class="st">"Work"</span>, <span class="st">"Bike"</span>, <span class="st">"08:30"</span>, <span class="fl">1</span>,
  <span class="st">"Work"</span>, <span class="st">"Park"</span>, <span class="st">"Walk"</span>, <span class="st">"11:30"</span>, <span class="fl">1</span>,
  <span class="st">"Park"</span>, <span class="st">"Cafe"</span>, <span class="st">"Walk"</span>, <span class="st">"12:15"</span>, <span class="fl">1</span>,
  <span class="st">"Cafe"</span>, <span class="st">"Work"</span>, <span class="st">"Walk"</span>, <span class="st">"12:45"</span>, <span class="fl">1</span>,
  <span class="st">"Work"</span>, <span class="st">"Home"</span>, <span class="st">"Bike"</span>, <span class="st">"17:00"</span>, <span class="fl">1</span>
<span class="op">)</span></code></pre></div>
<p>The two datasets can be joined, giving spatial attributes (origin and destination locations creating a straight line) for each OD pairs, using the <code>od_to_sf()</code> function from the <code>od</code> package as follows:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">od_sf</span> <span class="op">=</span> <span class="fu">od</span><span class="fu">::</span><span class="fu"><a href="https://itsleeds.github.io/od/reference/od_to_sf.html">od_to_sf</a></span><span class="op">(</span><span class="va">od</span>, <span class="va">places_sf</span><span class="op">)</span>
<span class="co">#&gt; 0 origins with no match in zone ids</span>
<span class="co">#&gt; 0 destinations with no match in zone ids</span>
<span class="co">#&gt;  points not in od data removed.</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">od_sf</span><span class="op">[</span><span class="st">"departure"</span><span class="op">]</span>, reset <span class="op">=</span> <span class="cn">FALSE</span>, key.pos <span class="op">=</span> <span class="fl">1</span>, lwd <span class="op">=</span> <span class="fl">6</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">places_sf</span><span class="op">$</span><span class="va">geometry</span>, pch <span class="op">=</span> <span class="va">places</span><span class="op">$</span><span class="va">name</span>, add <span class="op">=</span> <span class="cn">TRUE</span>, cex <span class="op">=</span><span class="fl">2</span><span class="op">)</span></code></pre></div>
<p><img src="activity_files/figure-html/unnamed-chunk-2-1.png" width="700"></p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># mapview::mapview(od_sf["departure"])</span></code></pre></div>
<p>As an aside, another way of representing the spatial attributes of the OD data: four columns with ‘X’ and ‘Y’ coordinates for both origins and destinations:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="op">(</span><span class="fu">od</span><span class="fu">::</span><span class="fu"><a href="https://itsleeds.github.io/od/reference/od_coordinates.html">od_coordinates</a></span><span class="op">(</span><span class="va">od_sf</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; Linking to GEOS 3.8.1, GDAL 3.2.1, PROJ 7.2.1</span>
<span class="co">#&gt;       ox     oy     dx     dy</span>
<span class="co">#&gt; 1 -1.524 53.819 -1.552 53.807</span>
<span class="co">#&gt; 2 -1.552 53.807 -1.560 53.812</span>
<span class="co">#&gt; 3 -1.560 53.812 -1.556 53.802</span>
<span class="co">#&gt; 4 -1.556 53.802 -1.552 53.807</span>
<span class="co">#&gt; 5 -1.552 53.807 -1.524 53.819</span></code></pre></div>
<p>We will assign departure times and randomise the exact time (representing the fact that people rarely depart when they plan to, let alone exactly on the hour) with the <code><a href="../reference/ab_time_normal.html">ab_time_normal()</a></code> function as follows:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">departure_times</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
  <span class="fl">8.5</span>,
  <span class="fl">11.5</span>,
  <span class="fl">12.25</span>,
  <span class="fl">12.75</span>,
  <span class="fl">17</span>
<span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">42</span><span class="op">)</span> <span class="co"># if you want deterministic results, set a seed.</span>
<span class="va">od_sf</span><span class="op">$</span><span class="va">departure</span> <span class="op">=</span> <span class="fu"><a href="../reference/ab_time_normal.html">ab_time_normal</a></span><span class="op">(</span>hr <span class="op">=</span> <span class="va">departure_times</span>, sd <span class="op">=</span> <span class="fl">0.15</span>, n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">departure_times</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>The <code><a href="../reference/ab_json.html">ab_json()</a></code> function converts the ‘spatial data frame’ representation of activity patterns shown above into the ‘nested list’ format required by A/B Street as follows (with the first line converting only the first row and the second line converting all 5 OD pairs):</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">od_json1</span> <span class="op">=</span> <span class="fu"><a href="../reference/ab_json.html">ab_json</a></span><span class="op">(</span><span class="va">od_sf</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span>, scenario_name <span class="op">=</span> <span class="st">"activity"</span><span class="op">)</span>
<span class="va">od_json</span> <span class="op">=</span> <span class="fu"><a href="../reference/ab_json.html">ab_json</a></span><span class="op">(</span><span class="va">od_sf</span>, scenario_name <span class="op">=</span> <span class="st">"activity"</span><span class="op">)</span></code></pre></div>
<p>Finally, the list representation can be saved as a <code>.json</code> file as follows:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/ab_save.html">ab_save</a></span><span class="op">(</span><span class="va">od_json1</span>, f <span class="op">=</span> <span class="st">"scenario1.json"</span><span class="op">)</span></code></pre></div>
<p>That results in the following file (see <a href="https://github.com/a-b-street/abstr/blob/main/inst/extdata/activity_leeds.json">activity_leeds.json</a> in the package’s external data for the full dataset in JSON form):</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/file.edit.html">file.edit</a></span><span class="op">(</span><span class="st">"scenario1.json"</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="sourceCode json"><code class="sourceCode json"><span id="cb12-1"><a href="#cb12-1"></a><span class="fu">{</span></span>
<span id="cb12-2"><a href="#cb12-2"></a>  <span class="dt">"scenario_name"</span><span class="fu">:</span> <span class="st">"activity"</span><span class="fu">,</span></span>
<span id="cb12-3"><a href="#cb12-3"></a>  <span class="dt">"people"</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb12-4"><a href="#cb12-4"></a>    <span class="fu">{</span></span>
<span id="cb12-5"><a href="#cb12-5"></a>      <span class="dt">"trips"</span><span class="fu">:</span> <span class="ot">[</span></span>
<span id="cb12-6"><a href="#cb12-6"></a>        <span class="fu">{</span></span>
<span id="cb12-7"><a href="#cb12-7"></a>          <span class="dt">"departure"</span><span class="fu">:</span> <span class="dv">313400000</span><span class="fu">,</span></span>
<span id="cb12-8"><a href="#cb12-8"></a>          <span class="dt">"origin"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb12-9"><a href="#cb12-9"></a>            <span class="dt">"Position"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb12-10"><a href="#cb12-10"></a>              <span class="dt">"longitude"</span><span class="fu">:</span> <span class="fl">-1.524</span><span class="fu">,</span></span>
<span id="cb12-11"><a href="#cb12-11"></a>              <span class="dt">"latitude"</span><span class="fu">:</span> <span class="fl">53.819</span></span>
<span id="cb12-12"><a href="#cb12-12"></a>            <span class="fu">}</span></span>
<span id="cb12-13"><a href="#cb12-13"></a>          <span class="fu">},</span></span>
<span id="cb12-14"><a href="#cb12-14"></a>          <span class="dt">"destination"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb12-15"><a href="#cb12-15"></a>            <span class="dt">"Position"</span><span class="fu">:</span> <span class="fu">{</span></span>
<span id="cb12-16"><a href="#cb12-16"></a>              <span class="dt">"longitude"</span><span class="fu">:</span> <span class="fl">-1.552</span><span class="fu">,</span></span>
<span id="cb12-17"><a href="#cb12-17"></a>              <span class="dt">"latitude"</span><span class="fu">:</span> <span class="fl">53.807</span></span>
<span id="cb12-18"><a href="#cb12-18"></a>            <span class="fu">}</span></span>
<span id="cb12-19"><a href="#cb12-19"></a>          <span class="fu">},</span></span>
<span id="cb12-20"><a href="#cb12-20"></a>          <span class="dt">"mode"</span><span class="fu">:</span> <span class="st">"Bike"</span><span class="fu">,</span></span>
<span id="cb12-21"><a href="#cb12-21"></a>          <span class="dt">"purpose"</span><span class="fu">:</span> <span class="st">"Work"</span></span>
<span id="cb12-22"><a href="#cb12-22"></a>        <span class="fu">}</span></span>
<span id="cb12-23"><a href="#cb12-23"></a>      <span class="ot">]</span></span>
<span id="cb12-24"><a href="#cb12-24"></a>    <span class="fu">}</span></span>
<span id="cb12-25"><a href="#cb12-25"></a>  <span class="ot">]</span></span>
<span id="cb12-26"><a href="#cb12-26"></a><span class="fu">}</span></span></code></pre></div>
<p>You can check the ‘round trip’ conversion of this JSON representation back into the data frame representation as follows:</p>
<!-- Todo: these are not totally identical, only the geomtry is: -->
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">od_sf_roundtrip</span> <span class="op">=</span> <span class="fu"><a href="../reference/ab_sf.html">ab_sf</a></span><span class="op">(</span>json <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"extdata/activity_leeds.json"</span>, package <span class="op">=</span> <span class="st">"abstr"</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/identical.html">identical</a></span><span class="op">(</span><span class="va">od_sf</span><span class="op">$</span><span class="va">geometry</span>, <span class="va">od_sf_roundtrip</span><span class="op">$</span><span class="va">geometry</span><span class="op">)</span> 
<span class="co">#&gt; [1] TRUE</span></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Nathanael Sheehan, Robin Lovelace, Trevor Nederlof, Dustin Carlino.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
